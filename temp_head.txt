?using AudioTranscriptionApp.Models;
using AudioTranscriptionApp.Services;
using Microsoft.Win32;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.IO;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using Markdig;
using System.Diagnostics;
using System.Windows.Media;


namespace AudioTranscriptionApp
{
    public partial class MainWindow : Window
    {
        private AudioCaptureService _audioCaptureService;
        private TranscriptionService _transcriptionService;
        private OpenAiChatService _openAiChatService;
        private bool _isRecording = false;
        private string _lastSaveDirectory = null;
        private int _audioTooShortWarningCount = 0;

        public MainWindow()
        {
            Logger.Info("Application starting.");
            InitializeComponent();

            Logger.Info("Initializing services...");
            _transcriptionService = new TranscriptionService(string.Empty);
            _openAiChatService = new OpenAiChatService(string.Empty);
            _audioCaptureService = new AudioCaptureService(_transcriptionService);

            // Set up event handlers
            Logger.Info("Setting up event handlers.");
            _audioCaptureService.SystemAudioLevelChanged += AudioCaptureService_SystemAudioLevelChanged; // Phase 3
            _audioCaptureService.MicrophoneLevelChanged += AudioCaptureService_MicrophoneLevelChanged; // Phase 3
            _audioCaptureService.TranscriptionReceived += AudioCaptureService_TranscriptionReceived;
            _audioCaptureService.StatusChanged += AudioCaptureService_StatusChanged;
            _audioCaptureService.ErrorOccurred += AudioCaptureService_ErrorOccurred;
            _audioCaptureService.RecordingTimeUpdate += AudioCaptureService_RecordingTimeUpdate;

            Logger.Info("Loading settings...");
            LoadApiKeys();

            // Add handler for auto-scrolling
            TranscriptionTextBox.TextChanged += TranscriptionTextBox_TextChanged;

            // Show instructions
            ShowInstructions();
        }

        private void LoadApiKeys()
        {
             try
            {
                // Whisper Key
                string encryptedApiKey = Properties.Settings.Default.ApiKey ?? string.Empty;
                string decryptedApiKey = EncryptionHelper.DecryptString(encryptedApiKey);
                if (!string.IsNullOrEmpty(decryptedApiKey))
                {
                     _transcriptionService.UpdateApiKey(decryptedApiKey);
                     Logger.Info("Whisper API key loaded from settings and applied to service.");
                }
                 else { Logger.Info("No Whisper API key found in settings."); }

                // Cleanup Key
                string encryptedCleanupKey = Properties.Settings.Default.CleanupApiKey ?? string.Empty;
                string decryptedCleanupKey = EncryptionHelper.DecryptString(encryptedCleanupKey);
                if (!string.IsNullOrEmpty(decryptedCleanupKey))
                {
                    _openAiChatService.UpdateApiKey(decryptedCleanupKey);
                    Logger.Info("Cleanup API key loaded from settings and applied to service.");
                }
                else { Logger.Info("No Cleanup API key found in settings."); }

                 // Summarize Key (Assuming it uses the same service instance for now)
                 string encryptedSummarizeKey = Properties.Settings.Default.SummarizeApiKey ?? string.Empty;
                 string decryptedSummarizeKey = EncryptionHelper.DecryptString(encryptedSummarizeKey);
                 if (!string.IsNullOrEmpty(decryptedSummarizeKey))
                 {
                      _openAiChatService.UpdateApiKey(decryptedSummarizeKey); // Update again if different key used
                      Logger.Info("Summarize API key loaded from settings and applied to service.");
                 }
                 else { Logger.Info("No Summarize API key found in settings."); }
            }
            catch (Exception ex)
            {
                Logger.Error("Failed to load API keys on startup.", ex);
            }
        }

        private void ShowInstructions()
        {
            string instructions =
                "AUDIO TRANSCRIPTION APP INSTRUCTIONS:\n\n" +
                "1. Click 'Settings' to configure API Keys and select Audio Sources.\n" + // Updated
                "3. Click 'Start' to begin transcribing.\n" +
                "4. Click 'Stop' when finished. Transcription is saved automatically.\n" +
                "5. Click 'Clean Up' to refine the transcription using AI.\n" +
                "6. Click 'Summarize' to generate a summary using AI.\n" +
                "7. Click 'Clear' to clear the text box.\n\n" +
                "Note: Use Mute checkboxes below to control which audio goes into the recording."; // Added note

            TranscriptionTextBox.Text = instructions;
            Logger.Info("Instructions displayed.");
        }

        // --- Phase 3 Event Handlers ---
        private void AudioCaptureService_SystemAudioLevelChanged(object sender, float level)
        {
             Dispatcher.Invoke(() => { SystemLevelBar.Value = level; });
        }

        private void AudioCaptureService_MicrophoneLevelChanged(object sender, float level)
        {
             Dispatcher.Invoke(() => { MicLevelBar.Value = level; });
        }

        private void MuteMicCheckBox_Changed(object sender, RoutedEventArgs e)
        {
             _audioCaptureService?.ToggleMicrophoneMute(MuteMicCheckBox.IsChecked ?? false);
        }

        private void MuteSystemAudioCheckBox_Changed(object sender, RoutedEventArgs e)
        {
             _audioCaptureService?.ToggleSystemAudioMute(MuteSystemAudioCheckBox.IsChecked ?? false);
        }
        // --- End Phase 3 Event Handlers ---

        private void AudioCaptureService_TranscriptionReceived(object sender, string text)
        {
            Dispatcher.Invoke(() => { TranscriptionTextBox.AppendText($"{text}\n\n"); });
        }

         private void AudioCaptureService_StatusChanged(object sender, string status)
        {
            Logger.Info($"Status changed: {status}");
            Dispatcher.Invoke(() => StatusTextBlock.Text = status);
        }

         private void AudioCaptureService_RecordingTimeUpdate(object sender, TimeSpan elapsed)
        {
            Dispatcher.Invoke(() => { ElapsedTimeTextBlock.Text = $"Rec: {elapsed.TotalSeconds:F0}s"; });
        }

        private void AudioCaptureService_ErrorOccurred(object sender, Exception ex)
        {
            bool isAudioTooShortError = ex.Message != null &&
                                        ex.Message.Contains("audio_too_short"); // Simplified check

            if (isAudioTooShortError)
            {
                _audioTooShortWarningCount++;
                string warningMsg = $"Warning ({_audioTooShortWarningCount}/3): Audio too short or silent. Check audio device or speak clearly.";
                Logger.Warning($"Audio too short warning received. Count: {_audioTooShortWarningCount}. Full error: {ex.Message}");

                Dispatcher.Invoke(() =>
                {
                    TranscriptionTextBox.AppendText($"\n--- {warningMsg} ---\n");
                    StatusTextBlock.Text = warningMsg;

                    if (_audioTooShortWarningCount >= 3)
                    {
                        Logger.Warning("Stopping recording due to repeated 'audio too short' warnings.");
                        StatusTextBlock.Text = "Stopping recording: Repeated audio issues detected.";
                        StopButton_Click(null, null); // Trigger stop
                    }
                });
            }
            else
            {
                Logger.Error("Error occurred in AudioCaptureService.", ex);
                Dispatcher.Invoke(() =>
                {
                    StatusTextBlock.Text = $"Error: {ex.Message}";
                    System.Windows.MessageBox.Show(ex.Message, "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                });
            }
        }

        private void StartButton_Click(object sender, RoutedEventArgs e)
        {
            Logger.Info("StartButton clicked.");
            string encryptedKeyCheck = Properties.Settings.Default.ApiKey ?? string.Empty;
            if (string.IsNullOrEmpty(EncryptionHelper.DecryptString(encryptedKeyCheck))) // Check decrypted key
            {
                 Logger.Warning("Start recording attempted without Whisper API key configured.");
                 System.Windows.MessageBox.Show("Please configure your OpenAI API key for Whisper in the Settings window first.", "API Key Required", MessageBoxButton.OK, MessageBoxImage.Warning);
                 return;
            }
             if (string.IsNullOrEmpty(Properties.Settings.Default.SystemAudioDeviceId) || string.IsNullOrEmpty(Properties.Settings.Default.MicrophoneDeviceId))
            {
                 Logger.Warning("Start recording attempted without audio devices selected.");
                 System.Windows.MessageBox.Show("Please select both a System Audio and Microphone source in Settings first.", "Audio Devices Required", MessageBoxButton.OK, MessageBoxImage.Warning);
                 return;
            }


            TranscriptionTextBox.Text = string.Empty;
            _lastSaveDirectory = null;
            _audioTooShortWarningCount = 0;
            ElapsedTimeTextBlock.Text = "Rec: 0s";
            ElapsedTimeTextBlock.Visibility = Visibility.Visible;
            Logger.Info("Transcription text box cleared and warning count reset.");

            // Reset mute checkboxes on start
            MuteMicCheckBox.IsChecked = false;
            MuteSystemAudioCheckBox.IsChecked = false;

            Logger.Info("Starting recording...");
